---
import SearchModal from './SearchModal.astro';
import {
  navigation as sidebar,
  getActiveSectionIndex,
  getSectionItemCount,
  type NavSection
} from '../config/navigation';

const currentPath = Astro.url.pathname;

// Find which section contains the active page
const activeSectionIndex = getActiveSectionIndex(currentPath);

// Find active subsection for sections with subsections
const getActiveSubsection = (section: NavSection) => {
  if (!section.subsections) return -1;
  return section.subsections.findIndex(sub =>
    sub.items.some(item =>
      currentPath === item.href || currentPath === item.href + '/'
    )
  );
};

// Count total items including subsections
const getTotalItems = getSectionItemCount;

// Icons as SVG paths
const icons: Record<string, string> = {
  rocket: '<path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"/><path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"/><path d="M9 12H4s.55-3.03 2-4c1.62-1.08 5 0 5 0"/><path d="M12 15v5s3.03-.55 4-2c1.08-1.62 0-5 0-5"/>',
  settings: '<path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/>',
  database: '<ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M3 5V19A9 3 0 0 0 21 19V5"/><path d="M3 12A9 3 0 0 0 21 12"/>',
  plug: '<path d="M12 22v-5"/><path d="M9 8V2"/><path d="M15 8V2"/><path d="M18 8v5a6 6 0 0 1-6 6v0a6 6 0 0 1-6-6V8Z"/>',
  zap: '<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>',
  code: '<polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/>',
  book: '<path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/><path d="M8 7h6"/><path d="M8 11h8"/>',
  layers: '<polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/>',
  activity: '<polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>',
  chevron: '<path d="m6 9 6 6 6-6"/>',
  chevronRight: '<path d="m9 18 6-6-6-6"/>',
  search: '<circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/>',
  github: '<path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"/><path d="M9 18c-4.51 2-5-2-7-2"/>',
  npm: '<path d="M1 8h22v8H12v2H7v-2H1z"/><path d="M7 8v8"/><path d="M12 8v8"/><path d="M17 8v8"/><path d="M17 12h3"/>',
};
---

<aside class="sidebar-wrapper">
  <!-- Fixed Header -->
  <div class="sidebar-fixed-header">
    <!-- Logo -->
    <div class="sidebar-header">
      <a href="/" class="sidebar-logo">
        <span class="logo-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
          </svg>
        </span>
        <span class="logo-text">hitlimit</span>
      </a>
      <span class="version-badge">v1.0.0</span>
    </div>

    <!-- Search -->
    <div class="search-container">
      <SearchModal />
    </div>
  </div>

  <!-- Scrollable Navigation -->
  <nav class="sidebar-nav">
    {sidebar.map((section, sectionIndex) => {
      const isActiveSection = sectionIndex === activeSectionIndex;
      const sectionId = `section-${sectionIndex}`;
      const shouldExpand = sectionIndex === 0 || isActiveSection;
      const activeSubsection = getActiveSubsection(section);
      const hasSubsections = !!section.subsections;

      return (
        <div class="sidebar-section" data-section={sectionIndex}>
          <button
            class={`section-header ${shouldExpand ? 'active' : ''}`}
            data-section-toggle={sectionIndex}
            aria-expanded={shouldExpand ? 'true' : 'false'}
            aria-controls={sectionId}
            type="button"
          >
            <div class="section-header-left">
              <span class="section-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" set:html={icons[section.icon]} />
              </span>
              <span class="section-title">{section.title}</span>
            </div>
            <div class="section-header-right">
              <span class="item-count">{getTotalItems(section)}</span>
              <span class={`chevron ${shouldExpand ? 'expanded' : ''}`}>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" set:html={icons.chevron} />
              </span>
            </div>
          </button>

          <div
            id={sectionId}
            class={`section-content ${shouldExpand ? 'expanded' : ''}`}
            data-section-content={sectionIndex}
          >
            {/* Regular items */}
            {section.items && (
              <ul class="section-items">
                {section.items.map((item) => {
                  const isActive = currentPath === item.href || currentPath === item.href + '/';
                  return (
                    <li>
                      <a
                        href={item.href}
                        class={`sidebar-link ${isActive ? 'active' : ''}`}
                        data-search-item
                        data-label={item.label}
                      >
                        <span class="link-indicator"></span>
                        <span class="link-text">{item.label}</span>
                      </a>
                    </li>
                  );
                })}
              </ul>
            )}

            {/* Subsections (for Bun) */}
            {section.subsections && (
              <div class="subsections">
                {section.subsections.map((subsection, subIndex) => {
                  const subId = `${sectionId}-sub-${subIndex}`;
                  const isSubActive = activeSubsection === subIndex;
                  const shouldExpandSub = isSubActive || subIndex === 0;

                  return (
                    <div class="subsection" data-subsection={subIndex}>
                      <button
                        class={`subsection-header ${shouldExpandSub ? 'active' : ''}`}
                        data-subsection-toggle={`${sectionIndex}-${subIndex}`}
                        aria-expanded={shouldExpandSub ? 'true' : 'false'}
                        aria-controls={subId}
                        type="button"
                      >
                        <span class={`sub-chevron ${shouldExpandSub ? 'expanded' : ''}`}>
                          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" set:html={icons.chevronRight} />
                        </span>
                        <span class="subsection-title">{subsection.title}</span>
                        <span class="sub-count">{subsection.items.length}</span>
                      </button>

                      <div
                        id={subId}
                        class={`subsection-content ${shouldExpandSub ? 'expanded' : ''}`}
                        data-subsection-content={`${sectionIndex}-${subIndex}`}
                      >
                        <ul class="subsection-items">
                          {subsection.items.map((item) => {
                            const isActive = currentPath === item.href || currentPath === item.href + '/';
                            return (
                              <li>
                                <a
                                  href={item.href}
                                  class={`sidebar-link nested ${isActive ? 'active' : ''}`}
                                  data-search-item
                                  data-label={item.label}
                                >
                                  <span class="link-indicator"></span>
                                  <span class="link-text">{item.label}</span>
                                </a>
                              </li>
                            );
                          })}
                        </ul>
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
          </div>
        </div>
      );
    })}
  </nav>

  <!-- Footer Links -->
  <div class="sidebar-footer">
    <a href="https://github.com/JointOps/hitlimit-monorepo" class="footer-link" target="_blank" rel="noopener noreferrer">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" set:html={icons.github} />
      <span>GitHub</span>
    </a>
    <a href="https://www.npmjs.com/package/@joint-ops/hitlimit" class="footer-link" target="_blank" rel="noopener noreferrer">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" set:html={icons.npm} />
      <span>npm</span>
    </a>
  </div>
</aside>

<style>
  .sidebar-wrapper {
    display: flex;
    flex-direction: column;
    height: 100%;
  }

  /* Fixed Header */
  .sidebar-fixed-header {
    flex-shrink: 0;
    padding: 1rem 1rem 0;
    background: var(--color-bg-primary);
    position: sticky;
    top: 0;
    z-index: 10;
  }

  /* Header */
  .sidebar-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 0.5rem;
    margin-bottom: 1rem;
  }

  .sidebar-logo {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    text-decoration: none;
    transition: opacity 0.2s;
  }

  .sidebar-logo:hover {
    opacity: 0.8;
  }

  .logo-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 1.75rem;
    height: 1.75rem;
    border-radius: 0.5rem;
    background: linear-gradient(135deg, var(--color-accent), var(--color-accent-secondary));
    color: black;
  }

  .logo-icon svg {
    width: 1rem;
    height: 1rem;
  }

  .logo-text {
    font-size: 1rem;
    font-weight: 700;
    color: white;
    letter-spacing: -0.02em;
  }

  .version-badge {
    font-size: 0.625rem;
    font-weight: 600;
    padding: 0.25rem 0.5rem;
    border-radius: 9999px;
    background: rgba(0, 229, 255, 0.1);
    color: var(--color-accent);
    font-family: var(--font-mono);
  }

  /* Search */
  .search-container {
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--color-border);
  }

  /* Navigation */
  .sidebar-nav {
    flex: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 0.125rem;
    padding: 1rem 1rem 0;
  }

  .sidebar-section {
    border-radius: 0.5rem;
  }

  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    padding: 0.5rem 0.625rem;
    border: none;
    background: transparent;
    cursor: pointer;
    border-radius: 0.5rem;
    transition: all 0.2s ease;
  }

  .section-header:hover {
    background: rgba(255, 255, 255, 0.04);
  }

  .section-header.active {
    background: rgba(0, 229, 255, 0.06);
  }

  .section-header-left {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .section-header-right {
    display: flex;
    align-items: center;
    gap: 0.375rem;
  }

  .section-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 1.5rem;
    height: 1.5rem;
    border-radius: 0.375rem;
    background: rgba(255, 255, 255, 0.06);
    color: var(--color-text-muted);
    transition: all 0.2s ease;
  }

  .section-icon svg {
    width: 0.75rem;
    height: 0.75rem;
  }

  .section-header:hover .section-icon,
  .section-header.active .section-icon {
    background: rgba(0, 229, 255, 0.15);
    color: var(--color-accent);
  }

  .section-title {
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--color-text-secondary);
    transition: color 0.2s ease;
  }

  .section-header:hover .section-title,
  .section-header.active .section-title {
    color: white;
  }

  .item-count {
    font-size: 0.625rem;
    font-weight: 500;
    padding: 0.125rem 0.375rem;
    border-radius: 9999px;
    background: rgba(255, 255, 255, 0.06);
    color: var(--color-text-muted);
    font-family: var(--font-mono);
  }

  .chevron {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 1rem;
    height: 1rem;
    color: var(--color-text-muted);
    transition: transform 0.2s ease, color 0.2s ease;
  }

  .chevron svg {
    width: 0.75rem;
    height: 0.75rem;
  }

  .chevron.expanded {
    transform: rotate(180deg);
    color: var(--color-accent);
  }

  /* Section Content */
  .section-content {
    display: grid;
    grid-template-rows: 0fr;
    transition: grid-template-rows 0.2s ease;
  }

  .section-content.expanded {
    grid-template-rows: 1fr;
  }

  .section-items {
    overflow: hidden;
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .section-content.expanded .section-items {
    padding-bottom: 0.375rem;
  }

  /* Subsections */
  .subsections {
    overflow: hidden;
    padding: 0.25rem 0;
  }

  .subsection {
    margin: 0.125rem 0;
  }

  .subsection-header {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    width: 100%;
    padding: 0.375rem 0.625rem 0.375rem 1.5rem;
    border: none;
    background: transparent;
    cursor: pointer;
    border-radius: 0.375rem;
    transition: all 0.15s ease;
  }

  .subsection-header:hover {
    background: rgba(255, 255, 255, 0.04);
  }

  .subsection-header.active {
    background: rgba(0, 229, 255, 0.04);
  }

  .sub-chevron {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 0.875rem;
    height: 0.875rem;
    color: var(--color-text-muted);
    transition: transform 0.15s ease, color 0.15s ease;
  }

  .sub-chevron svg {
    width: 0.625rem;
    height: 0.625rem;
  }

  .sub-chevron.expanded {
    transform: rotate(90deg);
    color: var(--color-accent);
  }

  .subsection-title {
    flex: 1;
    font-size: 0.6875rem;
    font-weight: 500;
    color: var(--color-text-muted);
    text-align: left;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    transition: color 0.15s ease;
  }

  .subsection-header:hover .subsection-title,
  .subsection-header.active .subsection-title {
    color: var(--color-text-secondary);
  }

  .sub-count {
    font-size: 0.5625rem;
    font-weight: 500;
    padding: 0.0625rem 0.25rem;
    border-radius: 9999px;
    background: rgba(255, 255, 255, 0.04);
    color: var(--color-text-muted);
    font-family: var(--font-mono);
  }

  /* Subsection Content */
  .subsection-content {
    display: grid;
    grid-template-rows: 0fr;
    transition: grid-template-rows 0.15s ease;
  }

  .subsection-content.expanded {
    grid-template-rows: 1fr;
  }

  .subsection-items {
    overflow: hidden;
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .subsection-content.expanded .subsection-items {
    padding: 0.125rem 0 0.25rem;
  }

  /* Sidebar Links */
  .sidebar-link {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.375rem 0.625rem 0.375rem 2.25rem;
    text-decoration: none;
    border-radius: 0.375rem;
    margin: 0.0625rem 0.25rem;
    transition: all 0.15s ease;
    position: relative;
  }

  .sidebar-link.nested {
    padding-left: 3rem;
  }

  .sidebar-link:hover {
    background: rgba(255, 255, 255, 0.04);
  }

  .sidebar-link:hover .link-text {
    color: var(--color-text-secondary);
  }

  .link-indicator {
    position: absolute;
    left: 1rem;
    width: 0.25rem;
    height: 0.25rem;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.15);
    transition: all 0.2s ease;
  }

  .sidebar-link.nested .link-indicator {
    left: 1.75rem;
  }

  .sidebar-link:hover .link-indicator {
    background: rgba(255, 255, 255, 0.3);
  }

  .sidebar-link.active .link-indicator {
    background: var(--color-accent);
    box-shadow: 0 0 6px var(--color-accent), 0 0 12px rgba(0, 229, 255, 0.4);
  }

  .link-text {
    font-size: 0.75rem;
    color: var(--color-text-muted);
    transition: color 0.15s ease;
  }

  .sidebar-link.active .link-text {
    color: var(--color-accent);
    font-weight: 500;
  }

  .sidebar-link.active {
    background: rgba(0, 229, 255, 0.08);
  }

  .sidebar-link.active::before {
    content: '';
    position: absolute;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 2px;
    height: 0.875rem;
    background: var(--color-accent);
    border-radius: 0 2px 2px 0;
    box-shadow: 0 0 6px var(--color-accent);
  }

  /* Footer */
  .sidebar-footer {
    flex-shrink: 0;
    display: flex;
    justify-content: center;
    gap: 0.25rem;
    padding: 1rem;
    margin: 0 1rem;
    border-top: 1px solid var(--color-border);
  }

  .footer-link {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.5rem 0.625rem;
    font-size: 0.6875rem;
    color: var(--color-text-muted);
    text-decoration: none;
    border-radius: 0.375rem;
    transition: all 0.2s;
  }

  .footer-link:hover {
    color: white;
    background: rgba(255, 255, 255, 0.04);
  }

  .footer-link svg {
    width: 0.875rem;
    height: 0.875rem;
  }
</style>

<script>
  function initSidebar() {
    // Toggle functionality for main sections
    const toggles = document.querySelectorAll<HTMLButtonElement>('[data-section-toggle]');

    toggles.forEach(toggle => {
      const newToggle = toggle.cloneNode(true) as HTMLButtonElement;
      toggle.parentNode?.replaceChild(newToggle, toggle);

      newToggle.addEventListener('click', (e) => {
        e.preventDefault();
        const sectionIndex = newToggle.getAttribute('data-section-toggle');
        const content = document.querySelector(`[data-section-content="${sectionIndex}"]`);
        const chevron = newToggle.querySelector('.chevron');
        const isExpanded = newToggle.getAttribute('aria-expanded') === 'true';

        newToggle.setAttribute('aria-expanded', String(!isExpanded));
        newToggle.classList.toggle('active', !isExpanded);
        content?.classList.toggle('expanded', !isExpanded);
        chevron?.classList.toggle('expanded', !isExpanded);
      });
    });

    // Toggle functionality for subsections
    const subToggles = document.querySelectorAll<HTMLButtonElement>('[data-subsection-toggle]');

    subToggles.forEach(toggle => {
      const newToggle = toggle.cloneNode(true) as HTMLButtonElement;
      toggle.parentNode?.replaceChild(newToggle, toggle);

      newToggle.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        const subIndex = newToggle.getAttribute('data-subsection-toggle');
        const content = document.querySelector(`[data-subsection-content="${subIndex}"]`);
        const chevron = newToggle.querySelector('.sub-chevron');
        const isExpanded = newToggle.getAttribute('aria-expanded') === 'true';

        newToggle.setAttribute('aria-expanded', String(!isExpanded));
        newToggle.classList.toggle('active', !isExpanded);
        content?.classList.toggle('expanded', !isExpanded);
        chevron?.classList.toggle('expanded', !isExpanded);
      });
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initSidebar);
  } else {
    initSidebar();
  }

  document.addEventListener('astro:after-swap', initSidebar);
</script>
