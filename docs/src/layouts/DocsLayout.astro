---
import '../styles/global.css';
import Nav from '../components/Nav.astro';
import Footer from '../components/Footer.astro';
import DocsSidebar from '../components/DocsSidebar.astro';
import { getPageNavigation } from '../config/navigation';
import SpeedInsights from '@vercel/speed-insights/astro';

interface Props {
  title?: string;
  description?: string;
  keywords?: string;
}

const {
  title = 'Documentation - hitlimit | Rate Limiting for Node.js, Bun, Express, Fastify, Hono & NestJS',
  description = 'Complete documentation for hitlimit rate limiter. Learn how to implement fast API rate limiting in Express, Fastify, Hono, NestJS, Bun, and Elysia with memory, SQLite, or Redis stores.',
  keywords = 'hitlimit docs, rate limit documentation, express rate limit guide, fastify rate limit, hono rate limit, hono rate limiter, nestjs throttler tutorial, bun rate limiter, elysia rate limit plugin, api rate limiting tutorial, nodejs rate limit example, redis rate limit setup, sqlite rate limit'
} = Astro.props;

const siteUrl = 'https://hitlimit.jointops.dev';
const ogImage = `${siteUrl}/og-image.png`;
const canonical = `${siteUrl}${Astro.url.pathname}`;

// Get prev/next navigation
const { prev, next } = getPageNavigation(Astro.url.pathname);
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <meta name="keywords" content={keywords} />
    <meta name="author" content="JointOps" />
    <meta name="robots" content="index, follow" />
    <meta name="googlebot" content="index, follow" />
    <meta name="theme-color" content="#00e5ff" />
    <!-- Preconnect hints for performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="dns-prefetch" href="https://github.com" />
    <link rel="icon" href="/favicon.ico" sizes="48x48" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <link rel="sitemap" href="/sitemap-index.xml" />
    <link rel="canonical" href={canonical} />
    <title>{title}</title>

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="article" />
    <meta property="og:url" content={canonical} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={ogImage} />
    <meta property="og:image:type" content="image/png" />
    <meta property="og:image:width" content="3344" />
    <meta property="og:image:height" content="1924" />
    <meta property="og:image:alt" content="hitlimit - The fastest rate limiting library for Node.js and Bun" />
    <meta property="og:site_name" content="hitlimit" />
    <meta property="og:locale" content="en_US" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content={canonical} />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImage} />
    <meta name="twitter:image:alt" content="hitlimit - The fastest rate limiting library for Node.js and Bun" />

    <!-- JSON-LD Structured Data for Documentation -->
    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "TechArticle",
      "headline": title,
      "description": description,
      "url": canonical,
      "image": ogImage,
      "datePublished": "2025-01-15",
      "dateModified": "2026-01-29",
      "author": {
        "@type": "Organization",
        "name": "JointOps",
        "url": "https://github.com/JointOps"
      },
      "publisher": {
        "@type": "Organization",
        "name": "JointOps",
        "url": "https://github.com/JointOps",
        "logo": {
          "@type": "ImageObject",
          "url": `${siteUrl}/og-image.png`
        }
      },
      "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": canonical
      },
      "keywords": keywords
    })} />

    <!-- BreadcrumbList Schema for AI search visibility -->
    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      "itemListElement": [
        {
          "@type": "ListItem",
          "position": 1,
          "name": "Home",
          "item": siteUrl
        },
        {
          "@type": "ListItem",
          "position": 2,
          "name": "Documentation",
          "item": `${siteUrl}/docs/`
        },
        {
          "@type": "ListItem",
          "position": 3,
          "name": title.replace(' - hitlimit', '').replace(' | Rate Limiting for Node.js, Bun, Express, NestJS', '')
        }
      ]
    })} />
  </head>
  <body class="min-h-screen">
    <!-- Subtle background gradient -->
    <div class="fixed inset-0 -z-10 pointer-events-none">
      <div class="absolute top-0 left-1/4 w-[600px] h-[600px] bg-[radial-gradient(ellipse_at_center,rgba(0,229,255,0.06),transparent_70%)] blur-3xl"></div>
    </div>

    <Nav />

    <!-- Mobile sidebar toggle -->
    <button id="mobile-sidebar-btn" class="fixed bottom-6 left-6 z-40 lg:hidden w-14 h-14 rounded-full bg-gradient-to-r from-[var(--color-accent)] to-[var(--color-accent-secondary)] text-black shadow-lg flex items-center justify-center hover:shadow-[0_0_30px_rgba(0,229,255,0.4)] transition-all" aria-label="Open navigation">
      <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <line x1="3" y1="6" x2="21" y2="6"/>
        <line x1="3" y1="12" x2="21" y2="12"/>
        <line x1="3" y1="18" x2="21" y2="18"/>
      </svg>
    </button>

    <!-- Mobile sidebar drawer -->
    <div id="mobile-sidebar-overlay" class="fixed inset-0 z-50 hidden lg:hidden">
      <div id="mobile-sidebar-backdrop" class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
      <aside id="mobile-sidebar-drawer" class="absolute left-0 top-0 bottom-0 w-80 max-w-[85vw] bg-[var(--color-bg-base)] border-r border-[var(--color-border)] overflow-y-auto -translate-x-full transition-transform duration-300">
        <div class="flex items-center justify-between p-4 border-b border-[var(--color-border)]">
          <span class="text-sm font-semibold text-[var(--color-text-muted)] uppercase tracking-wider">Navigation</span>
          <button id="mobile-sidebar-close" class="p-2 rounded-lg hover:bg-white/5 text-[var(--color-text-muted)] hover:text-white transition-colors" aria-label="Close navigation">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M18 6L6 18M6 6l12 12"/>
            </svg>
          </button>
        </div>
        <DocsSidebar />
      </aside>
    </div>

    <div class="flex pt-24">
      <!-- Sidebar (desktop) -->
      <aside class="hidden lg:block w-72 flex-shrink-0">
        <div class="fixed top-24 w-72 h-[calc(100vh-6rem)] border-r border-[var(--color-border)] overflow-hidden">
          <DocsSidebar />
        </div>
      </aside>

      <!-- Main content -->
      <main class="flex-1 min-w-0 px-4 sm:px-6 lg:px-12 py-8 max-w-4xl">
        <!-- Mobile TOC -->
        <details id="mobile-toc-details" class="xl:hidden mb-8 rounded-lg border border-[var(--color-border)] bg-[var(--color-bg-surface)]">
          <summary class="px-4 py-3 text-sm font-semibold cursor-pointer text-[var(--color-text-muted)] hover:text-white transition-colors select-none">On this page</summary>
          <nav id="mobile-toc" class="px-4 pb-4 text-sm space-y-1"></nav>
        </details>

        <article class="prose prose-invert prose-lg max-w-none">
          <slot />
        </article>

        <!-- Pagination -->
        <nav class="mt-16 pt-8 border-t border-[var(--color-border)]" aria-label="Documentation pages">
          <div class="flex flex-col sm:flex-row items-stretch justify-between gap-4">
            {prev ? (
              <a href={prev.href} class="group flex-1 flex flex-col gap-1 p-4 rounded-lg border border-[var(--color-border)] hover:border-[var(--color-primary)] hover:bg-[var(--color-primary)]/5 transition-all">
                <span class="flex items-center gap-2 text-sm text-[var(--color-text-secondary)]">
                  <svg class="w-4 h-4 transition-transform group-hover:-translate-x-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  Previous
                </span>
                <span class="font-medium text-white group-hover:text-[var(--color-primary)] transition-colors">{prev.label}</span>
                <span class="text-xs text-[var(--color-text-secondary)]">{prev.section}</span>
              </a>
            ) : (
              <div class="flex-1"></div>
            )}
            {next ? (
              <a href={next.href} class="group flex-1 flex flex-col items-end gap-1 p-4 rounded-lg border border-[var(--color-border)] hover:border-[var(--color-primary)] hover:bg-[var(--color-primary)]/5 transition-all text-right">
                <span class="flex items-center gap-2 text-sm text-[var(--color-text-secondary)]">
                  Next
                  <svg class="w-4 h-4 transition-transform group-hover:translate-x-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M5 12h14M12 5l7 7-7 7" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </span>
                <span class="font-medium text-white group-hover:text-[var(--color-primary)] transition-colors">{next.label}</span>
                <span class="text-xs text-[var(--color-text-secondary)]">{next.section}</span>
              </a>
            ) : (
              <div class="flex-1"></div>
            )}
          </div>
        </nav>
      </main>

      <!-- Table of Contents -->
      <aside class="hidden xl:block w-64 flex-shrink-0">
        <div class="toc-wrapper">
          <div class="toc-header">
            <svg class="toc-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="8" y1="6" x2="21" y2="6"/>
              <line x1="8" y1="12" x2="21" y2="12"/>
              <line x1="8" y1="18" x2="21" y2="18"/>
              <line x1="3" y1="6" x2="3.01" y2="6"/>
              <line x1="3" y1="12" x2="3.01" y2="12"/>
              <line x1="3" y1="18" x2="3.01" y2="18"/>
            </svg>
            <span>On this page</span>
          </div>
          <div class="toc-progress-container">
            <div class="toc-progress-bar" id="toc-progress"></div>
          </div>
          <nav id="toc" class="toc-nav">
            <!-- TOC will be populated by JS -->
          </nav>
          <div class="toc-actions">
            <button class="toc-action-btn" id="scroll-to-top" title="Scroll to top">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="19" x2="12" y2="5"/>
                <polyline points="5 12 12 5 19 12"/>
              </svg>
            </button>
          </div>
        </div>
      </aside>
    </div>
    <SpeedInsights />
  </body>
</html>

<style is:global>
  /* Prose overrides for docs */
  .prose {
    --tw-prose-body: var(--color-text-secondary);
    --tw-prose-headings: var(--color-text-primary);
    --tw-prose-links: var(--color-accent);
    --tw-prose-code: var(--color-accent);
  }

  .prose h1 {
    font-size: 2.5rem;
    font-weight: 800;
    letter-spacing: -0.03em;
    background: linear-gradient(135deg, var(--color-accent) 0%, var(--color-accent-secondary) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 1rem;
  }

  .prose h2 {
    font-size: 1.75rem;
    font-weight: 700;
    letter-spacing: -0.02em;
    margin-top: 3rem;
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--color-border);
    position: relative;
  }

  .prose h2::after {
    content: '';
    position: absolute;
    bottom: -1px;
    left: 0;
    width: 50px;
    height: 2px;
    background: linear-gradient(90deg, var(--color-accent), var(--color-accent-secondary));
    border-radius: 1px;
  }

  .prose h3 {
    font-size: 1.25rem;
    font-weight: 600;
    margin-top: 2rem;
    margin-bottom: 0.75rem;
  }

  .prose p {
    line-height: 1.8;
    margin-bottom: 1.25rem;
  }

  .prose a {
    text-decoration: none;
    transition: all 0.2s;
  }

  .prose a:hover {
    text-shadow: 0 0 20px rgba(0, 229, 255, 0.5);
  }

  .prose code:not(pre code) {
    background: var(--color-bg-elevated);
    color: var(--color-accent);
    padding: 0.2em 0.5em;
    border-radius: 6px;
    font-size: 0.875em;
    font-family: var(--font-mono);
    border: 1px solid var(--color-border);
  }

  .prose ul, .prose ol {
    margin: 1.5rem 0;
    padding-left: 1.5rem;
  }

  .prose li {
    margin-bottom: 0.5rem;
    line-height: 1.7;
  }

  .prose li::marker {
    color: var(--color-accent);
  }

  .prose blockquote {
    border-left: 3px solid var(--color-accent);
    background: var(--color-bg-surface);
    padding: 1rem 1.5rem;
    margin: 1.5rem 0;
    border-radius: 0 8px 8px 0;
  }

  .prose table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    border: 1px solid var(--color-border);
    border-radius: 12px;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    display: block;
    margin: 2rem 0;
  }

  .prose th {
    background: var(--color-bg-surface);
    font-weight: 600;
    text-align: left;
    padding: 1rem;
    border-bottom: 1px solid var(--color-border);
  }

  .prose td {
    padding: 1rem;
    border-bottom: 1px solid var(--color-border);
  }

  .prose tr:last-child td {
    border-bottom: none;
  }

  .prose hr {
    border: none;
    height: 1px;
    background: var(--color-border);
    margin: 3rem 0;
  }

  /* Table of Contents */
  .toc-wrapper {
    position: fixed;
    top: 6rem;
    width: 16rem;
    max-height: calc(100vh - 8rem);
    padding: 1.25rem;
    display: flex;
    flex-direction: column;
  }

  .toc-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.6875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--color-text-muted);
    margin-bottom: 1rem;
  }

  .toc-icon {
    width: 0.875rem;
    height: 0.875rem;
    opacity: 0.7;
  }

  .toc-progress-container {
    height: 2px;
    background: var(--color-border);
    border-radius: 1px;
    margin-bottom: 1rem;
    overflow: hidden;
  }

  .toc-progress-bar {
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, var(--color-accent), var(--color-accent-secondary));
    border-radius: 1px;
    transition: width 0.15s ease-out;
    box-shadow: 0 0 8px rgba(0, 229, 255, 0.5);
  }

  .toc-nav {
    flex: 1;
    overflow-y: auto;
    position: relative;
    padding-left: 0.75rem;
  }

  .toc-nav::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 1px;
    background: var(--color-border);
  }

  .toc-link {
    display: flex;
    align-items: flex-start;
    gap: 0.625rem;
    padding: 0.5rem 0;
    text-decoration: none;
    position: relative;
    transition: all 0.2s ease;
  }

  .toc-link-indicator {
    position: absolute;
    left: -0.75rem;
    top: 50%;
    transform: translateY(-50%);
    width: 3px;
    height: 0;
    background: var(--color-accent);
    border-radius: 0 2px 2px 0;
    transition: all 0.2s ease;
  }

  .toc-link.active .toc-link-indicator {
    height: 1rem;
    box-shadow: 0 0 8px var(--color-accent), 0 0 16px rgba(0, 229, 255, 0.3);
  }

  .toc-link-text {
    font-size: 0.8125rem;
    line-height: 1.4;
    color: var(--color-text-muted);
    transition: all 0.2s ease;
  }

  .toc-link:hover .toc-link-text {
    color: var(--color-text-secondary);
  }

  .toc-link.active .toc-link-text {
    color: var(--color-accent);
    font-weight: 500;
    text-shadow: 0 0 20px rgba(0, 229, 255, 0.3);
  }

  .toc-link.h3 {
    padding-left: 1rem;
  }

  .toc-link.h3 .toc-link-text {
    font-size: 0.75rem;
  }

  .toc-actions {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid var(--color-border);
    display: flex;
    justify-content: center;
  }

  .toc-action-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 2rem;
    height: 2rem;
    border: 1px solid var(--color-border);
    border-radius: 0.5rem;
    background: rgba(255, 255, 255, 0.02);
    color: var(--color-text-muted);
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .toc-action-btn:hover {
    background: rgba(0, 229, 255, 0.1);
    border-color: var(--color-accent);
    color: var(--color-accent);
    box-shadow: 0 0 12px rgba(0, 229, 255, 0.2);
  }

  .toc-action-btn svg {
    width: 0.875rem;
    height: 0.875rem;
  }

  /* Empty state */
  .toc-empty {
    font-size: 0.75rem;
    color: var(--color-text-muted);
    font-style: italic;
    padding: 0.5rem 0;
  }

  /* Responsive typography */
  @media (max-width: 640px) {
    .prose h1 {
      font-size: 1.75rem;
    }
    .prose h2 {
      font-size: 1.25rem;
    }
  }

  /* Mobile TOC links */
  .mobile-toc-link {
    display: block;
    padding: 0.375rem 0;
    color: var(--color-text-muted);
    text-decoration: none;
    transition: color 0.2s;
  }
  .mobile-toc-link:hover {
    color: var(--color-accent);
  }
  .mobile-toc-link.h3 {
    padding-left: 1rem;
    font-size: 0.8125rem;
  }
</style>

<script>
  function initMobileSidebar() {
    const btn = document.getElementById('mobile-sidebar-btn');
    const overlay = document.getElementById('mobile-sidebar-overlay');
    const backdrop = document.getElementById('mobile-sidebar-backdrop');
    const drawer = document.getElementById('mobile-sidebar-drawer');
    const closeBtn = document.getElementById('mobile-sidebar-close');

    if (!btn || !overlay || !drawer) return;

    let scrollPos = 0;

    function openDrawer() {
      scrollPos = window.scrollY;
      overlay.classList.remove('hidden');
      requestAnimationFrame(() => {
        drawer.classList.remove('-translate-x-full');
        document.body.style.overflow = 'hidden';
        document.body.style.position = 'fixed';
        document.body.style.width = '100%';
        document.body.style.top = `-${scrollPos}px`;
      });
    }

    function closeDrawer() {
      drawer.classList.add('-translate-x-full');
      document.body.style.overflow = '';
      document.body.style.position = '';
      document.body.style.width = '';
      document.body.style.top = '';
      window.scrollTo(0, scrollPos);
      setTimeout(() => overlay.classList.add('hidden'), 300);
    }

    btn.addEventListener('click', openDrawer);
    closeBtn?.addEventListener('click', closeDrawer);
    backdrop?.addEventListener('click', closeDrawer);

    // Close on link click inside drawer
    drawer.querySelectorAll('a').forEach(a => {
      a.addEventListener('click', closeDrawer);
    });

    // Close on Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !overlay.classList.contains('hidden')) closeDrawer();
    });
  }

  function initTOC() {
    const article = document.querySelector('article');
    const toc = document.getElementById('toc');
    const mobileToc = document.getElementById('mobile-toc');
    const progressBar = document.getElementById('toc-progress');
    const scrollToTopBtn = document.getElementById('scroll-to-top');

    if (!article) return;

    // Clear existing TOC
    if (toc) toc.innerHTML = '';
    if (mobileToc) mobileToc.innerHTML = '';

    const headings = article.querySelectorAll('h2, h3');

    if (headings.length === 0) {
      if (toc) toc.innerHTML = '<div class="toc-empty">No sections found</div>';
      return;
    }

    // Generate TOC links
    headings.forEach((heading, index) => {
      const id = heading.id || `heading-${index}`;
      heading.id = id;

      // Desktop TOC link
      if (toc) {
        const link = document.createElement('a');
        link.href = `#${id}`;
        link.className = `toc-link ${heading.tagName.toLowerCase()}`;
        link.dataset.target = id;
        link.innerHTML = `
          <span class="toc-link-indicator"></span>
          <span class="toc-link-text">${heading.textContent}</span>
        `;

        link.addEventListener('click', (e) => {
          e.preventDefault();
          const target = document.getElementById(id);
          if (target) {
            const offset = 100;
            const top = target.getBoundingClientRect().top + window.scrollY - offset;
            window.scrollTo({ top, behavior: 'smooth' });
            history.pushState(null, '', `#${id}`);
          }
        });

        toc.appendChild(link);
      }

      // Mobile TOC link
      if (mobileToc) {
        const mLink = document.createElement('a');
        mLink.href = `#${id}`;
        mLink.className = `mobile-toc-link ${heading.tagName.toLowerCase()}`;
        mLink.textContent = heading.textContent;
        mLink.addEventListener('click', (e) => {
          e.preventDefault();
          const details = document.getElementById('mobile-toc-details') as HTMLDetailsElement;
          if (details) details.open = false;
          const target = document.getElementById(id);
          if (target) {
            const offset = 100;
            const top = target.getBoundingClientRect().top + window.scrollY - offset;
            window.scrollTo({ top, behavior: 'smooth' });
            history.pushState(null, '', `#${id}`);
          }
        });
        mobileToc.appendChild(mLink);
      }
    });

    // Scroll spy - highlight active section
    const tocLinks = toc.querySelectorAll('.toc-link');

    function updateActiveSection() {
      const scrollPosition = window.scrollY + 120;
      const windowHeight = window.innerHeight;
      const docHeight = document.documentElement.scrollHeight;
      const isNearBottom = (window.scrollY + windowHeight) >= (docHeight - 100);

      let activeIndex = -1;

      // Find the current active heading
      headings.forEach((heading, index) => {
        if (heading.offsetTop <= scrollPosition) {
          activeIndex = index;
        }
      });

      // If near bottom of page, highlight the last visible heading
      if (isNearBottom && headings.length > 0) {
        // Find the last heading that's visible in the viewport
        for (let i = headings.length - 1; i >= 0; i--) {
          const rect = headings[i].getBoundingClientRect();
          if (rect.top < windowHeight) {
            activeIndex = i;
            break;
          }
        }
      }

      // Ensure at least the first heading is highlighted when at top
      if (activeIndex === -1 && headings.length > 0) {
        activeIndex = 0;
      }

      tocLinks.forEach((link, index) => {
        link.classList.toggle('active', index === activeIndex);
      });
    }

    // Progress bar
    function updateProgress() {
      const scrollTop = window.scrollY;
      const docHeight = document.documentElement.scrollHeight - window.innerHeight;
      const progress = docHeight > 0 ? (scrollTop / docHeight) * 100 : 0;
      if (progressBar) {
        progressBar.style.width = `${Math.min(progress, 100)}%`;
      }
    }

    // Scroll handler with throttling
    let ticking = false;
    function onScroll() {
      if (!ticking) {
        requestAnimationFrame(() => {
          updateActiveSection();
          updateProgress();
          ticking = false;
        });
        ticking = true;
      }
    }

    window.addEventListener('scroll', onScroll, { passive: true });

    // Initial update
    updateActiveSection();
    updateProgress();

    // Scroll to top button
    if (scrollToTopBtn) {
      scrollToTopBtn.addEventListener('click', () => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
    }

    // Handle initial hash
    if (window.location.hash) {
      const targetId = window.location.hash.slice(1);
      const target = document.getElementById(targetId);
      if (target) {
        setTimeout(() => {
          const offset = 100;
          const top = target.getBoundingClientRect().top + window.scrollY - offset;
          window.scrollTo({ top, behavior: 'smooth' });
        }, 100);
      }
    }
  }

  function initAll() {
    initTOC();
    initMobileSidebar();
  }

  // Initialize
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAll);
  } else {
    initAll();
  }

  // Re-init on Astro page transitions
  document.addEventListener('astro:after-swap', initAll);
</script>
